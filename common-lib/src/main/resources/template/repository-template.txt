package ${package-name};

@vn.com.lcx.common.annotation.Component
public class ${proxy-class-name} implements ${interface-class-name} {

${methods}
    public io.vertx.core.Future<vn.com.lcx.common.database.pageable.Page<${entity-class-name}>> find(io.vertx.ext.web.RoutingContext context, io.vertx.sqlclient.SqlConnection connection, vn.com.lcx.reactive.helper.SqlStatement statement, java.util.ArrayList<Object> parameters, vn.com.lcx.common.database.pageable.Pageable pageable) {
        String databaseName = connection.databaseMetadata().productName();
        String placeholder;
        if (databaseName.equals("PostgreSQL")) {
            placeholder = "$";
        } else if (databaseName.equals("MySQL") || databaseName.equals("MariaDB")) {
            placeholder = "?";
        } else if (databaseName.equals("Microsoft SQL Server")) {
            placeholder = "@p";
        } else if (databaseName.equals("Oracle")) {
            placeholder = "?";
        } else {
            throw new vn.com.lcx.jpa.exception.CodeGenError("Unsupported database type");
        }
        return vn.com.lcx.reactive.wrapper.SqlConnectionLcxWrapper.init(connection, context)
                .preparedQuery(
                        vn.com.lcx.reactive.utils.QueryProcessor.processQueryStatement(
                                statement.finalizeQueryStatement(pageable),
                                parameters,
                                placeholder
                        )
                )
                .execute(io.vertx.sqlclient.Tuple.tuple(parameters))
                .map(rowSet ->
                        {
                            final java.util.List<${entity-class-name}> result = new java.util.ArrayList<>();
                            for (io.vertx.sqlclient.Row row : rowSet) {
                                result.add(vn.com.lcx.reactive.context.EntityMappingContainer.<${entity-class-name}>getMapping(${entity-class-name}.class.getName()).vertxRowMapping(row));
                            }
                            return result;
                        }
                )
                .compose(rs ->
                        vn.com.lcx.reactive.wrapper.SqlConnectionLcxWrapper.init(connection, context)
                                .preparedQuery(
                                        vn.com.lcx.reactive.utils.QueryProcessor.processQueryStatement(
                                                statement.finalizeCountStatement(),
                                                parameters,
                                                placeholder
                                        )
                                )
                                .execute(io.vertx.sqlclient.Tuple.tuple(parameters))
                                .map(rowSet -> {
                                    long countRs = 0L;
                                    for (io.vertx.sqlclient.Row row : rowSet) {
                                        countRs = countRs + row.getLong(0);
                                        break;
                                    }
                                    return vn.com.lcx.common.database.pageable.Page.create(rs, countRs, pageable.getPageNumber(), pageable.getPageSize());
                                })
                );

    }

    public io.vertx.core.Future<java.util.List<${entity-class-name}>> find(io.vertx.ext.web.RoutingContext context, io.vertx.sqlclient.SqlConnection connection, vn.com.lcx.reactive.helper.SqlStatement statement, java.util.ArrayList<Object> parameters) {
        String databaseName = connection.databaseMetadata().productName();
        String placeholder;
        if (databaseName.equals("PostgreSQL")) {
            placeholder = "$";
        } else if (databaseName.equals("MySQL") || databaseName.equals("MariaDB")) {
            placeholder = "?";
        } else if (databaseName.equals("Microsoft SQL Server")) {
            placeholder = "@p";
        } else if (databaseName.equals("Oracle")) {
            placeholder = "?";
        } else {
            throw new vn.com.lcx.jpa.exception.CodeGenError("Unsupported database type");
        }
        return vn.com.lcx.reactive.wrapper.SqlConnectionLcxWrapper.init(connection, context)
                .preparedQuery(
                        vn.com.lcx.reactive.utils.QueryProcessor.processQueryStatement(
                                statement.finalizeQueryStatement(),
                                parameters,
                                placeholder
                        )
                )
                .execute(io.vertx.sqlclient.Tuple.tuple(parameters))
                .map(rowSet ->
                        {
                            final java.util.List<${entity-class-name}> result = new java.util.ArrayList<>();
                            for (io.vertx.sqlclient.Row row : rowSet) {
                                result.add(vn.com.lcx.reactive.context.EntityMappingContainer.<${entity-class-name}>getMapping(${entity-class-name}.class.getName()).vertxRowMapping(row));
                            }
                            return result;
                        }
                );

    }

}
